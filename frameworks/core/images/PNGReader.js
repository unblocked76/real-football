gloft.PNGReader=gloft.Class.extend({ctor:function(h){var c,a,o,k,b,j,l,n,m,g,p,e,d,f;this.data=h;this.pos=8;this.palette=[];this.imgData=[];this.transparency={};this.animation=null;this.text={};b=null;while(true){c=this.readUInt32();m=((function(){var q,i;i=[];for(j=q=0;q<4;j=++q){i.push(String.fromCharCode(this.data[this.pos++]))}return i}).call(this)).join("");switch(m){case"IHDR":this.width=this.readUInt32();this.height=this.readUInt32();this.bits=this.data[this.pos++];this.colorType=this.data[this.pos++];this.compressionMethod=this.data[this.pos++];this.filterMethod=this.data[this.pos++];this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||Infinity,frames:[]};break;case"PLTE":this.palette=this.read(c);break;case"fcTL":if(b){this.animation.frames.push(b)}this.pos+=4;b={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};k=this.readUInt16();o=this.readUInt16()||100;b.delay=1000*k/o;b.disposeOp=this.data[this.pos++];b.blendOp=this.data[this.pos++];b.data=[];break;case"IDAT":case"fdAT":if(m==="fdAT"){this.pos+=4;c-=4}h=(b!=null?b.data:void 0)||this.imgData;for(j=e=0;0<=c?e<c:e>c;j=0<=c?++e:--e){h.push(this.data[this.pos++])}break;case"tRNS":this.transparency={};switch(this.colorType){case 3:this.transparency.indexed=this.read(c);g=255-this.transparency.indexed.length;if(g>0){for(j=d=0;0<=g?d<g:d>g;j=0<=g?++d:--d){this.transparency.indexed.push(255)}}break;case 0:this.transparency.grayscale=this.read(c)[0];break;case 2:this.transparency.rgb=this.read(c)}break;case"tEXt":p=this.read(c);l=p.indexOf(0);n=String.fromCharCode.apply(String,p.slice(0,l));this.text[n]=String.fromCharCode.apply(String,p.slice(l+1));break;case"IEND":if(b){this.animation.frames.push(b)}this.colors=(function(){switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}).call(this);this.hasAlphaChannel=(f=this.colorType)===4||f===6;a=this.colors+(this.hasAlphaChannel?1:0);this.pixelBitlength=this.bits*a;this.colorSpace=(function(){switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}).call(this);if(Uint8Array!=Array){this.imgData=new Uint8Array(this.imgData)}return;default:this.pos+=c}this.pos+=4;if(this.pos>this.data.length){throw new Error("Incomplete or corrupt PNG file")}}},read:function(b){var c,d,a;a=[];for(c=d=0;0<=b?d<b:d>b;c=0<=b?++d:--d){a.push(this.data[this.pos++])}return a},readUInt32:function(){var d,c,b,a;d=this.data[this.pos++]<<24;c=this.data[this.pos++]<<16;b=this.data[this.pos++]<<8;a=this.data[this.pos++];return d|c|b|a},readUInt16:function(){var b,a;b=this.data[this.pos++]<<8;a=this.data[this.pos++];return b|a},decodePixels:function(B){var e,A,q,x,n,m,v,h,w,f,b,t,u,r,s,z,y,k,l,j,g,d,a;if(B==null){B=this.imgData}if(B.length===0){return new Uint8Array(0)}var o=new Zlib.Inflate(B,{index:0,verify:false});B=o.decompress();t=this.pixelBitlength/8;z=t*this.width;u=new Uint8Array(z*this.height);m=B.length;s=0;r=0;A=0;while(r<m){switch(B[r++]){case 0:for(x=l=0;l<z;x=l+=1){u[A++]=B[r++]}break;case 1:for(x=j=0;j<z;x=j+=1){e=B[r++];n=x<t?0:u[A-t];u[A++]=(e+n)%256}break;case 2:for(x=g=0;g<z;x=g+=1){e=B[r++];q=(x-(x%t))/t;y=s&&u[(s-1)*z+q*t+(x%t)];u[A++]=(y+e)%256}break;case 3:for(x=d=0;d<z;x=d+=1){e=B[r++];q=(x-(x%t))/t;n=x<t?0:u[A-t];y=s&&u[(s-1)*z+q*t+(x%t)];u[A++]=(e+Math.floor((n+y)/2))%256}break;case 4:for(x=a=0;a<z;x=a+=1){e=B[r++];q=(x-(x%t))/t;n=x<t?0:u[A-t];if(s===0){y=k=0}else{y=u[(s-1)*z+q*t+(x%t)];k=q&&u[(s-1)*z+(q-1)*t+(x%t)]}v=n+y-k;h=Math.abs(v-n);f=Math.abs(v-y);b=Math.abs(v-k);if(h<=f&&h<=b){w=n}else{if(f<=b){w=y}else{w=k}}u[A++]=(e+w)%256}break;default:throw new Error("Invalid filter algorithm: "+B[r-1])}s++}return u},copyToImageData:function(a,e){var g,b,m,n,o,h,f,c,d,p,l;b=this.colors;d=null;g=this.hasAlphaChannel;if(this.palette.length){d=(l=this._decodedPalette)!=null?l:this._decodedPalette=this.decodePalette();b=4;g=true}m=a.data||a;c=m.length;o=d||e;n=h=0;if(b===1){while(n<c){f=d?e[n/4]*4:h;p=o[f++];m[n++]=p;m[n++]=p;m[n++]=p;m[n++]=g?o[f++]:255;h=f}}else{while(n<c){f=d?e[n/4]*4:h;m[n++]=o[f++];m[n++]=o[f++];m[n++]=o[f++];m[n++]=g?o[f++]:255;h=f}}},decodePalette:function(){var j,g,a,k,h,b,e,f,d;a=this.palette;b=this.transparency.indexed||[];h=new Uint8Array((b.length||0)+a.length);k=0;j=0;for(g=e=0,f=a.length;e<f;g=e+=3){h[k++]=a[g];h[k++]=a[g+1];h[k++]=a[g+2];h[k++]=(d=b[j++])!=null?d:255}return h},render:function(b){var a,c;b.width=this.width;b.height=this.height;a=b.getContext("2d");c=a.createImageData(this.width,this.height);this.copyToImageData(c,this.decodePixels());return a.putImageData(c,0,0)}});