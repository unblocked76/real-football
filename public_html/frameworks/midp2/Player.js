"use strict";var _p=window;var AbstractAudioPlayer=gloft.Class.extend({m_proxySoundStarted:null,m_proxySoundStopped:null,m_proxySoundEnded:null,m_proxySoundClosed:null,m_proxyError:null,ctor:function(d,a,b,e,c){this.m_proxySoundStarted=d;this.m_proxySoundStopped=b;this.m_proxySoundEnded=a;this.m_proxySoundClosed=e;this.m_proxyError=c},doStart:function(){throw new Error("Abstract!")},doStop:function(){throw new Error("Abstract!")},doClose:function(){throw new Error("Abstract!")},});var HTMLAudioPlayer=AbstractAudioPlayer.extend({m_player:null,ctor:function(g,e,d,h,f,c,a){AbstractAudioPlayer.prototype.ctor.call(this,d,h,f,c,a);if(e==""){throw new Error("Please detect type from 12 first bytes of stream.")}this.m_player=document.createElement("audio");var b=g;if(typeof g=="string"){b=g}else{var i=[];g.read(i,0,g.available());b="data:"+e+";base64,"+gloft.arrayBufferToBase64(i)}this.m_player.autoplay=false;this.m_player.preload="none";this.m_player.src=b;HTMLAudioPlayer.s_QueueLoading.push(this)},doStart:function(){var a=this.m_player;try{this.m_player.removeEventListener(HTMLAudioPlayer._AUDIO_ENDED,this.m_proxySoundEnded,false)}catch(c){throw new c}try{a.addEventListener(HTMLAudioPlayer._AUDIO_ENDED,this.m_proxySoundEnded,false);if(!a.paused){a.pause()}a.playbackRate=1;a.volume=1;a.loop=false;a.muted=false;a.load();var b=a.play();if(b&&(typeof Promise!=="undefined")&&(b instanceof Promise)&&b["catch"]){b["catch"](function(d){a.play()})}}catch(c){throw c}this.m_proxySoundStarted()},doStop:function(){try{this.m_player.removeEventListener(HTMLAudioPlayer._AUDIO_ENDED,this.m_proxySoundEnded,false)}catch(a){throw new a}try{if(!this.m_player.paused){this.m_player.pause()}}catch(a){throw new a}this.m_proxySoundStopped()},doClose:function(){try{this.m_player.removeEventListener(HTMLAudioPlayer._AUDIO_ENDED,this.m_proxySoundEnded,false)}catch(a){throw new a}try{if(!this.m_player.paused){this.m_player.pause()}}catch(a){throw new a}this.m_proxySoundClosed()},});HTMLAudioPlayer._AUDIO_ENDED="ended";HTMLAudioPlayer.s_QueueLoading=[];function createGain(a){if(a.createGain){return a.createGain()}else{return a.createGainNode()}}function startSource(a){if(a.start){a.start(0)}else{a.noteOn(0)}}function startSourceAt(b,a,c){if(b.start){b.start(0,a)}else{b.noteGrainOn(0,a,c-a)}}function stopSource(a){try{if(a.stop){a.stop(0)}else{a.noteOff(0)}}catch(b){}}var WebAudioPlayer=AbstractAudioPlayer.extend({ctor:function(g,e,d,i,f,b,a){AbstractAudioPlayer.prototype.ctor.call(this,d,i,f,b,a);this.m_pan=0;this.m_playbackResource=null;this.m_LocalGainNode=createGain(WebAudioPlayer.context);this.m_PanNode=WebAudioPlayer.context.createPanner();this.m_PanNode.panningModel=WebAudioPlayer.s_PanningModel;this.m_PanNode.connect(this.m_LocalGainNode);this._updatePan();this.m_SourceNode=null;this.m_durationMils=0;if(typeof g=="string"){var c;var h=this;c=new XMLHttpRequest();c.open("GET",g,true);c.responseType="arraybuffer";c.onload=function(){h.m_AudioEncoded=c.response;WebAudioPlayer.s_QueueDecoding.push(h);WebAudioPlayer._proccessDecodeAudioSync()};c.onerror=function(){h.failedToLoad=true};c.send()}else{this.m_AudioEncoded=this._parseAudioDataEncoded(g);WebAudioPlayer.s_QueueDecoding.push(this);WebAudioPlayer._proccessDecodeAudioSync()}},_parseAudioDataEncoded:function(c){var b=[];c.read(b,0,c.available());var a=new Uint8Array(b.length);a.set(new Uint8Array(b),0);return a.buffer},_updatePan:function(){this.m_PanNode.setPosition(this.m_pan,0,-0.5)},_cleanUpAudio:function(){if(this.m_SourceNode){this.m_SourceNode.onended=null;stopSource(this.m_SourceNode);this.m_SourceNode.disconnect(0);this.m_SourceNode=null}if(this.m_LocalGainNode.numberOfOutputs!=0){this.m_LocalGainNode.disconnect(0)}},doStart:function(){var b=this;if(!b.loadstate){throw new Error("Pls load before. Nerver go here!!!!!")}else{if(b.loadstate=="started"){gloft.warn("Pls waiting. Nerver go here!!!!!")}else{if(b.loadstate=="error"){gloft.warn("The sound is loading fail: "+b.loaderror)}else{if(this.m_playbackResource!=null&&this.m_LocalGainNode){b._cleanUpAudio();b.m_LocalGainNode.connect(WebAudioPlayer.s_MasterGainNode);var a=WebAudioPlayer.context.createBufferSource();a.buffer=b.m_playbackResource;a.connect(b.m_PanNode);a.onended=b.m_proxySoundEnded;b.m_SourceNode=a;startSource(b.m_SourceNode);b.m_proxySoundStarted()}else{throw new Error("lnthieu: Why go here? Nerver go here!!!!!")}}}}},doStop:function(){this._cleanUpAudio();this.m_proxySoundStopped()},doClose:function(){this._cleanUpAudio();this.m_PanNode.disconnect(0);this.m_PanNode=null;this.m_LocalGainNode.disconnect(0);this.m_LocalGainNode=null;this.m_playbackResource=null;this.m_AudioEncoded=null;this.m_proxySoundClosed()},});WebAudioPlayer.s_QueueDecoding=[];WebAudioPlayer._proccessDecodeAudioSync=function(){var a=WebAudioPlayer.s_QueueDecoding.shift();if(a==null){WebAudioPlayer.s_proccessDecodeAudioSync_isLoading=false}else{WebAudioPlayer._proccessDecodeAudioSyncStart(a)}};WebAudioPlayer._proccessDecodeAudioSyncStart=function(a){a.loadstate="started";WebAudioPlayer.context.decodeAudioData(a.m_AudioEncoded,function(b){WebAudioPlayer._proccessDecodeAudioSyncComplete(a,b)},function(b){WebAudioPlayer._proccessDecodeAudioSyncError(a,b)})};WebAudioPlayer._proccessDecodeAudioSyncError=function(a,b){a.loadstate="error";a.loaderror=b;WebAudioPlayer._proccessDecodeAudioSync()};WebAudioPlayer._proccessDecodeAudioSyncComplete=function(a,b){a.m_playbackResource=b;a.m_AudioEncoded=null;a.loadstate="complete";WebAudioPlayer._proccessDecodeAudioSync()};WebAudioPlayer.initialize=function(){if(WebAudioPlayer.context!=null){return}WebAudioPlayer.context=null;if(window.AudioContext){WebAudioPlayer.context=new AudioContext()}else{if(window.webkitAudioContext){WebAudioPlayer.context=new webkitAudioContext()}else{throw new Error("AudioContext is not supported.")}}WebAudioPlayer.s_PanningModel="equalpower";WebAudioPlayer.s_DynamicsCompressorNode=WebAudioPlayer.context.createDynamicsCompressor();WebAudioPlayer.s_DynamicsCompressorNode.connect(WebAudioPlayer.context.destination);WebAudioPlayer.s_MasterGainNode=createGain(WebAudioPlayer.context);WebAudioPlayer.s_MasterGainNode.connect(WebAudioPlayer.s_DynamicsCompressorNode);WebAudioPlayer.s_ScratchBuffer=WebAudioPlayer.context.createBuffer(1,1,22050)};WebAudioPlayer.isSupport=function(){if(window.AudioContext||window.webkitAudioContext){return true}return false};var VolumeControl=gloft.Class.extend({m_Player:null,ctor:function(a){this.m_Player=a},getLevel:function(){gloft.warn("VolumeControl: Not implemented yet")},isMuted:function(){gloft.warn("VolumeControl: Not implemented yet")},setLevel:function(a){gloft.warn("VolumeControl: Not implemented yet")},setMute:function(a){gloft.warn("VolumeControl: Not implemented yet")},setVolume:function(b,a){gloft.warn("VolumeControl: Not implemented yet")},});var Controllable=gloft.Class.extend({m_VolumeControl:null,m_ToneControl:null,ctor:function(a,b){this.m_VolumeControl=a;this.m_ToneControl=b},getControl:function(a){if(a=="VolumeControl"){return this.m_VolumeControl}else{if(a=="ToneControl"){return this.m_ToneControl}else{return null}}},getControls:function(){var a=[];if(this.m_VolumeControl!=null){a.push(this.m_VolumeControl)}if(this.m_ToneControl!=null){a.push(this.m_ToneControl)}return a},});var javax=_p.javax=_p.javax||{};var microedition=_p.javax.microedition=_p.javax.microedition||{};var media=_p.javax.microedition.media=_p.javax.microedition.media||{};var Player=_p.javax.microedition.media.Player=Controllable.extend({ctor:function(c,f){Controllable.prototype.ctor.call(this,new VolumeControl(this),null);var e=gloft.proxy(this._handleSoundStarted,this);var a=gloft.proxy(this._handleSoundEnded,this);var b=gloft.proxy(this._handleSoundStopped,this);var g=gloft.proxy(this._handleSoundClosed,this);var d=gloft.proxy(this._handleError,this);this.m_AudioPLayer=new Player.factoryClass(c,f,e,a,b,g,d);this.id=Player.s_GenID++;this.m_state=Player.UNREALIZED;this.m_listeners=[]},addPlayerListener:function(a){if(this.m_state==Player.CLOSED){throw new Error("IllegalStateException")}else{if(a!=null){this.m_listeners.push(a)}}},close:function(){if(this.m_state==Player.CLOSED){return}this.m_state=Player.CLOSED;this.m_AudioPLayer.doClose()},deallocate:function(){if(this.m_state==Player.CLOSED){throw new Error("IllegalStateException")}else{if(this.m_state==Player.STARTED){this.stop()}else{if(this.m_state==Player.PREFETCHED){this.m_state=Player.REALIZED}else{if(this.m_state==Player.REALIZED){this.m_state=Player.UNREALIZED}}}}},getContentType:function(){throw new Error("Interface method!")},getDuration:function(){throw new Error("Interface method!")},getMediaTime:function(){throw new Error("Interface method!")},getState:function(){return this.m_state},prefetch:function(){if(this.m_state==Player.CLOSED){throw new Error("IllegalStateException")}else{if(this.m_state==Player.UNREALIZED){this.realize();this.m_state=Player.PREFETCHED}else{if(this.m_state==Player.REALIZED){this.m_state=Player.PREFETCHED}}}},realize:function(){if(this.m_state==Player.CLOSED){throw new Error("IllegalStateException")}else{if(this.m_state==Player.UNREALIZED){this.m_state=Player.REALIZED}}},removePlayerListener:function(a){throw new Error("Interface method!")},setLoopCount:function(a){if(a==0){throw new Error("IllegalArgumentException: count is invalid.")}if(this.m_state==Player.STARTED||this.m_state==Player.CLOSED){throw new Error("IllegalStateException: Player is in the STARTED or CLOSED state.")}this.m_iLoopCount=a},setMediaTime:function(a){gloft.warn("Not supported yet.")},start:function(){if(this.m_state==Player.CLOSED){throw new Error("IllegalStateException")}else{if(this.m_state!=Player.STARTED){this.m_state=Player.STARTED;this.m_iLoopRemaining=this.m_iLoopCount;this.m_AudioPLayer.doStart()}}},stop:function(){gloft.log(this.id+"="+this.m_state);if(this.m_state==Player.CLOSED){throw new Error("IllegalStateException")}else{if(this.m_state==Player.STARTED){this.m_state=Player.PREFETCHED;this.m_AudioPLayer.doStop()}}},_notifyListeners:function(d,c){for(var b=0,a=this.m_listeners.length;b<a;b++){this.m_listeners[b](this,d,c)}},_handleError:function(a){this._notifyListeners(PlayerListener.ERROR,"Error with decoding audio data"+a);Err("Error with decoding audio data"+a)},_handleSoundStarted:function(){this._notifyListeners(PlayerListener.STARTED,0)},_handleSoundEnded:function(){gloft.log("end:"+this.id+"="+this.m_state);if(this.m_state==Player.STARTED){this.m_state=Player.PREFETCHED;this._notifyListeners(PlayerListener.END_OF_MEDIA,0)}if(this.m_iLoopCount==-1||(--this.m_iLoopRemaining)>0){this.m_state=Player.STARTED;this.m_AudioPLayer.doStart()}},_handleSoundStopped:function(){gloft.log("stoped:"+this.id+"="+this.m_state);this._notifyListeners(PlayerListener.STOPPED,0)},_handleSoundClosed:function(){gloft.log("close:"+this.id+"="+this.m_state);this._notifyListeners(PlayerListener.CLOSED,null)},});Player.s_GenID=0;Player.CLOSED=0;Player.PREFETCHED=300;Player.REALIZED=200;Player.STARTED=400;Player.TIME_UNKNOWN=-1;Player.UNREALIZED=100;var supportWebAudio=WebAudioPlayer.isSupport();if(gloft.runtime.config.audioMode===1){Player.factoryClass=HTMLAudioPlayer}else{Player.factoryClass=supportWebAudio?WebAudioPlayer:HTMLAudioPlayer}Player.type=Player.factoryClass==WebAudioPlayer?"wau":"hau";if(Player.factoryClass.initialize){Player.factoryClass.initialize()}Player._touchEvent=("ontouchstart" in window)?"touchstart":"mousedown";Player._touchTarget=gloft.runtime.canvas||document.body;Player._processUserInputEvent=function(c){Player.type=Player.factoryClass==WebAudioPlayer?"WAU":"HAU";gloft.warn("This method should be called under a touchend event!");Player.onready=c;if(Player.factoryClass==WebAudioPlayer){if(WebAudioPlayer.context){var d=WebAudioPlayer.context.createBufferSource();var a=WebAudioPlayer.s_ScratchBuffer;d.connect(WebAudioPlayer.context.destination);startSourceAt(d,0,0)}if(Player.onready){Player.onready();Player.onready=false}}else{var b;while(b=HTMLAudioPlayer.s_QueueLoading.shift()){b.m_player.load()}if(Player.onready){Player.onready();Player.onready=false}}};(function(){function a(){Player._touchTarget.removeEventListener(Player._touchEvent,a);Player._processUserInputEvent()}Player._touchTarget.addEventListener(Player._touchEvent,a)})();function ToneControl(){}ToneControl.prototype.setSequence=function(a){gloft.warn("** javax.microedition.media.control.ToneControlImpl.setSequence(byte[] sequence) not implemented yet **")};ToneControl.VERSION=-2;ToneControl.TEMPO=-3;ToneControl.RESOLUTION=-4;ToneControl.BLOCK_START=-5;ToneControl.BLOCK_END=-6;ToneControl.PLAY_BLOCK=-7;ToneControl.SET_VOLUME=-8;ToneControl.REPEAT=-9;ToneControl.C4=60;ToneControl.SILENCE=-1;function PlayerListener(){}PlayerListener.prototype.playerUpdate=function(a,c,b){throw new Error("Interface method!")};PlayerListener.STARTED="started";PlayerListener.STOPPED="stopped";PlayerListener.END_OF_MEDIA="endOfMedia";PlayerListener.DURATION_UPDATED="durationUpdated";PlayerListener.DEVICE_UNAVAILABLE="deviceUnavailable";PlayerListener.DEVICE_AVAILABLE="deviceAvailable";PlayerListener.VOLUME_CHANGED="volumeChanged";PlayerListener.ERROR="error";PlayerListener.CLOSED="closed";