gloft.tiffReader={_littleEndian:false,_tiffData:null,_fileDirectories:[],getUint8:function(a){return this._tiffData[a]},getUint16:function(a){if(this._littleEndian){return(this._tiffData[a+1]<<8)|(this._tiffData[a])}else{return(this._tiffData[a]<<8)|(this._tiffData[a+1])}},getUint32:function(c){var b=this._tiffData;if(this._littleEndian){return(b[c+3]<<24)|(b[c+2]<<16)|(b[c+1]<<8)|(b[c])}else{return(b[c]<<24)|(b[c+1]<<16)|(b[c+2]<<8)|(b[c+3])}},checkLittleEndian:function(){var a=this.getUint16(0);if(a===18761){this.littleEndian=true}else{if(a===19789){this.littleEndian=false}else{console.log(a);throw TypeError("Invalid byte order value.")}}return this.littleEndian},hasTowel:function(){if(this.getUint16(2)!==42){throw RangeError("You forgot your towel!");return false}return true},getFieldTypeName:function(a){var b=this.fieldTypeNames;if(a in b){return b[a]}return null},getFieldTagName:function(b){var a=this.fieldTagNames;if(b in a){return a[b]}else{console.log("Unknown Field Tag:",b);return"Tag"+b}},getFieldTypeLength:function(a){if(["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(a)!==-1){return 1}else{if(["SHORT","SSHORT"].indexOf(a)!==-1){return 2}else{if(["LONG","SLONG","FLOAT"].indexOf(a)!==-1){return 4}else{if(["RATIONAL","SRATIONAL","DOUBLE"].indexOf(a)!==-1){return 8}}}}return null},getFieldValues:function(j,h,g,b){var c=[];var d=this.getFieldTypeLength(h);var a=d*g;if(a<=4){if(this.littleEndian===false){c.push(b>>>((4-d)*8))}else{c.push(b)}}else{for(var e=0;e<g;e++){var f=d*e;if(d>=8){if(["RATIONAL","SRATIONAL"].indexOf(h)!==-1){c.push(this.getUint32(b+f));c.push(this.getUint32(b+f+4))}else{gloft.log("Can't handle this field type or size")}}else{c.push(this.getBytes(d,b+f))}}}if(h==="ASCII"){c.forEach(function(m,l,k){k[l]=String.fromCharCode(m)})}return c},getBytes:function(a,b){if(a<=0){gloft.log("No bytes requested")}else{if(a<=1){return this.getUint8(b)}else{if(a<=2){return this.getUint16(b)}else{if(a<=3){return this.getUint32(b)>>>8}else{if(a<=4){return this.getUint32(b)}else{gloft.log("Too many bytes requested")}}}}}},getBits:function(b,a,h){h=h||0;var i=Math.floor(h/8);var g=a+i;var d=h+b;var f=32-b;var e,c;if(d<=0){console.log("No bits requested")}else{if(d<=8){e=24+h;c=this.getUint8(g)}else{if(d<=16){e=16+h;c=this.getUint16(g)}else{if(d<=32){e=h;c=this.getUint32(g)}else{console.log("Too many bits requested")}}}}return{bits:((c<<e)>>>f),byteOffset:g+Math.floor(d/8),bitOffset:d%8}},parseFileDirectory:function(e){var j=this.getUint16(e);var k=[];for(var f=e+2,l=0;l<j;f+=12,l++){var d=this.getUint16(f);var g=this.getUint16(f+2);var h=this.getUint32(f+4);var a=this.getUint32(f+8);var n=this.getFieldTagName(d);var m=this.getFieldTypeName(g);var c=this.getFieldValues(n,m,h,a);k[n]={type:m,values:c}}this._fileDirectories.push(k);var b=this.getUint32(f);if(b!==0){this.parseFileDirectory(b)}},clampColorSample:function(b,a){var c=Math.pow(2,8-a);return Math.floor((b*c)+(c-1))},parseTIFF:function(aa,h){h=h||document.createElement("canvas");this._tiffData=aa;this.canvas=h;this.checkLittleEndian();if(!this.hasTowel()){return}var u=this.getUint32(4);this._fileDirectories.length=0;this.parseFileDirectory(u);var a=this._fileDirectories[0];var am=a.ImageWidth.values[0];var al=a.ImageLength.values[0];this.canvas.width=am;this.canvas.height=al;var H=[];var b=(a.Compression)?a.Compression.values[0]:1;var K=a.SamplesPerPixel.values[0];var J=[];var r=0;var X=false;a.BitsPerSample.values.forEach(function(j,k,m){J[k]={bitsPerSample:j,hasBytesPerSample:false,bytesPerSample:undefined};if((j%8)===0){J[k].hasBytesPerSample=true;J[k].bytesPerSample=j/8}r+=j},this);if((r%8)===0){X=true;var c=r/8}var ae=a.StripOffsets.values;var Q=ae.length;if(a.StripByteCounts){var s=a.StripByteCounts.values}else{gloft.log("Missing StripByteCounts!");if(Q===1){var s=[Math.ceil((am*al*r)/8)]}else{throw Error("Cannot recover from missing StripByteCounts")}}for(var ag=0;ag<Q;ag++){var P=ae[ag];H[ag]=[];var q=s[ag];for(var D=0,G=0,d=1,R=true,C=[],g=0,p=0,M=0;D<q;D+=d){switch(b){case 1:for(var Z=0,C=[];Z<K;Z++){if(J[Z].hasBytesPerSample){var N=J[Z].bytesPerSample*Z;C.push(this.getBytes(J[Z].bytesPerSample,P+D+N))}else{var ah=this.getBits(J[Z].bitsPerSample,P+D,G);C.push(ah.bits);D=ah.byteOffset-P;G=ah.bitOffset;throw RangeError("Cannot handle sub-byte bits per sample")}}H[ag].push(C);if(X){d=c}else{d=0;throw RangeError("Cannot handle sub-byte bits per pixel")}break;case 2:break;case 3:break;case 4:break;case 5:break;case 6:break;case 7:break;case 32773:if(R){R=false;var z=1;var ad=1;var e=this.getInt8(P+D);if((e>=0)&&(e<=127)){z=e+1}else{if((e>=-127)&&(e<=-1)){ad=-e+1}else{R=true}}}else{var E=this.getUint8(P+D);for(var Z=0;Z<ad;Z++){if(J[p].hasBytesPerSample){M=(M<<(8*g))|E;g++;if(g===J[p].bytesPerSample){C.push(M);M=g=0;p++}}else{throw RangeError("Cannot handle sub-byte bits per sample")}if(p===K){H[ag].push(C);C=[];p=0}}z--;if(z===0){R=true}}d=1;break;default:break}}}if(h.getContext){var B=this.canvas.getContext("2d");B.fillStyle="rgba(255, 255, 255, 0)";var l=a.RowsPerStrip?a.RowsPerStrip.values[0]:al;var n=H.length;var w=al%l;var f=(w===0)?l:w;var U=l;var ak=0;var ai=a.PhotometricInterpretation.values[0];var V=[];var O=0;if(a.ExtraSamples){V=a.ExtraSamples.values;O=V.length}if(a.ColorMap){var I=a.ColorMap.values;var t=Math.pow(2,J[0].bitsPerSample)}for(var ag=0;ag<n;ag++){if((ag+1)===n){U=f}var aj=H[ag].length;var o=ak*ag;for(var S=0,ac=0;S<U,ac<aj;S++){for(var T=0;T<am;T++,ac++){var v=H[ag][ac];var W=0;var Y=0;var F=0;var af=1;if(O>0){for(var ab=0;ab<O;ab++){if(V[ab]===1||V[ab]===2){af=v[3+ab]/256;break}}}switch(ai){case 0:if(J[0].hasBytesPerSample){var L=Math.pow(16,J[0].bytesPerSample*2)}v.forEach(function(k,j,i){i[j]=L-k});case 1:W=Y=F=this.clampColorSample(v[0],J[0].bitsPerSample);break;case 2:W=this.clampColorSample(v[0],J[0].bitsPerSample);Y=this.clampColorSample(v[1],J[1].bitsPerSample);F=this.clampColorSample(v[2],J[2].bitsPerSample);break;case 3:if(I===undefined){throw Error("Palette image missing color map")}var A=v[0];W=this.clampColorSample(I[A],16);Y=this.clampColorSample(I[t+A],16);F=this.clampColorSample(I[(2*t)+A],16);break;default:throw RangeError("Unknown Photometric Interpretation:",ai);break}B.fillStyle="rgba("+W+", "+Y+", "+F+", "+af+")";B.fillRect(T,o+S,1,1)}}ak=U}}return this.canvas},fieldTagNames:{315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},fieldTypeNames:{1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"}};